<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë””ìì¸ ì•„ì´ë””ì–´ ê¸°ë¡ ì‹œìŠ¤í…œ</title>

  <!-- ZIP ì €ì¥ìš© ë¼ì´ë¸ŒëŸ¬ë¦¬ (JSZip & FileSaver.js) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background-color: #fff;
      max-width: 1000px;
      margin: auto;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }
    .guide {
      font-size: 0.95rem;
      background-color: #f9f9f9;
      border-left: 4px solid #888;
      padding: 1rem;
      margin-bottom: 2rem;
      line-height: 1.6;
    }
    .idea-item {
      margin-bottom: 1.5rem;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      position: relative;
    }
    .idea-item strong {
      font-size: 1.3rem;
    }
    .idea-item label {
      font-weight: bold;
      display: block;
      margin-top: 0.8rem;
    }
    .idea-item input[type="text"],
    .idea-item textarea {
      width: 100%;
      padding: 0.5rem;
      box-sizing: border-box;
      margin-top: 0.3rem;
    }
    .role-buttons button,
    .platform-tag-buttons button,
    .gpt-help-buttons button,
    .satisfaction-buttons button,
    .image-satisfaction-buttons button {
      margin-right: 1rem;
      margin-top: 0.3rem;
      padding: 0.4rem 1rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background-color: #eee;
      color: #333;
    }
    .role-buttons button.selected[data-role="0"] {
      background-color: #e74c3c;
      color: white;
    }
    .role-buttons button.selected[data-role="1"] {
      background-color: #3498db;
      color: white;
    }
    .platform-tag-buttons button.selected,
    .gpt-help-buttons button.selected,
    .satisfaction-buttons button.selected,
    .image-satisfaction-buttons button.selected {
      background-color: #2ecc71;
      color: white;
    }
    .add-button {
      display: block;
      margin: 1rem auto;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      border: none;
      background-color: #333;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
    }
    img.preview {
      margin-top: 0.5rem;
      max-width: 200px;
      display: none;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .image-controls {
      margin-top: 0.3rem;
    }
    .image-controls button {
      background-color: #e74c3c;
      color: white;
      border: none;
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 0.5rem;
    }
    #student-name {
      width: 200px;
      padding: 0.4rem;
      margin-bottom: 1rem;
    }
      .delete-item{
      position:absolute;
      top:8px;
      right:8px;
      background-color:#ff6b6b;
      color:#fff;
      border:none;
      padding:0.25rem 0.6rem;
      border-radius:6px;
      cursor:pointer;
      font-size:0.85rem;
    }
    .delete-item:hover{opacity:0.9;}
    .confirm-bar{position:absolute;top:8px;right:74px;display:none;align-items:center;gap:6px;background:#fff;border:1px solid #ddd;padding:4px 6px;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.06);}
    .confirm-bar button{border:none;padding:0.2rem 0.5rem;border-radius:4px;cursor:pointer;}
    .confirm-yes{background:#ff6b6b;color:#fff;}
    .confirm-no{background:#eee;}
  </style>

  <!-- ìƒˆë¡œê³ ì¹¨ ì‹œ ê²½ê³  -->
  <script>
    window.addEventListener('beforeunload', (e) => {
      e.preventDefault();
      e.returnValue = "ì…ë ¥ëœ ì´ë¯¸ì§€ íŒŒì¼ì€ ìƒˆë¡œê³ ì¹¨í•˜ë©´ ì‚¬ë¼ì§‘ë‹ˆë‹¤. ì €ì¥ì„ ë¨¼ì € í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
    });
  </script>
</head>
<body>
  <h1>ë””ìì¸ ì•„ì´ë””ì–´ ê¸°ë¡ ì‹œìŠ¤í…œ</h1>

  <!-- ì‹¤í—˜ ëª©ì  ë° ì•ˆë‚´ -->
  <div class="guide">
    <p><strong>ì‹¤í—˜ ëª©ì :</strong> ì´ í¼ì€ ì—¬ëŸ¬ë¶„ì´ ë””ìì¸ ê³¼ì •ì—ì„œ ë§Œë“  ì•„ì´ë””ì–´ë¥¼ ê¸°ë¡í•˜ê³ , ê·¸ ì•„ì´ë””ì–´ê°€ ì–´ë–»ê²Œ ìƒì„±ë˜ì—ˆëŠ”ì§€, ì—°ê´€ë˜ì–´ ìˆëŠ”ì§€ë¥¼ ë¶„ì„í•˜ê¸° ìœ„í•œ ì‹¤í—˜ì…ë‹ˆë‹¤.</p>
    <ul>
      <li>1. ì•„ì´ë””ì–´ê°€ ë– ì˜¤ë¥¸ ìˆœì„œëŒ€ë¡œ ì…ë ¥í•˜ì„¸ìš”.</li>
      <li>2. ê·¸ ì•„ì´ë””ì–´ê°€ <strong>'ì§ì ‘ ìƒê°í•œ ê²ƒ'</strong>ì¸ì§€ <strong>'AI ì´ë¯¸ì§€ ìƒì„±ê¸°ë¥¼ í™œìš©í•œ ê²ƒ'</strong>ì¸ì§€ ì„ íƒí•˜ì„¸ìš”.</li>
      <li>3. AI ì´ë¯¸ì§€ ìƒì„±ê¸°ë¥¼ ì‚¬ìš©í–ˆë‹¤ë©´ ì–´ë–¤ í”Œë«í¼ì„ ì‚¬ìš©í–ˆëŠ”ì§€ ì„ íƒí•˜ê³ , í”„ë¡¬í”„íŠ¸ì™€ ìƒì„±ëœ ì´ë¯¸ì§€ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.</li>
      <li>4. í”„ë¡¬í”„íŠ¸ë¥¼ ì‘ì„±í•  ë•Œ ë‹¤ë¥¸ AIì˜ ë„ì›€(GPT ë“±)ì„ ë°›ì•˜ëŠ”ì§€ë„ í‘œì‹œí•´ì£¼ì„¸ìš”.</li>
      <li>5. í”„ë¡¬í”„íŠ¸ ë§Œì¡±ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”.</li>
      <li>6. ëª¨ë“  í•­ëª©ì„ ì„±ì‹¤íˆ ì‘ì„±í•´ì•¼ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </div>

  <!-- ì°¸ê°€ì ì´ë¦„ ì…ë ¥ë€ -->
  <label>
    <strong>ì°¸ê°€ì ì´ë¦„:</strong>
    <input type="text" id="student-name" placeholder="ì˜ˆ: í™ê¸¸ë™" />
  </label>

  <div id="idea-list"></div>
  <button class="add-button" id="add-button">ì…ë ¥ ì¶”ê°€</button>
  <button class="add-button" id="save-json">JSON ì €ì¥</button>

  <script>
    // ë¯¸ë¦¬ë³´ê¸° ë° ì‚­ì œ í•¨ìˆ˜ (ì´ë¯¸ì§€)
    function previewImage(event, idx, type) {
      const input = event.target;
      const preview = document.getElementById(`preview-${type}-${idx}`);
      const deleteBtn = document.getElementById(`delete-${type}-${idx}`);
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.src = e.target.result;
          preview.style.display = 'block';
          if (deleteBtn) deleteBtn.style.display = 'inline-block';
          autoSave();
        };
        reader.readAsDataURL(input.files[0]);
      }
    }
    function deleteImage(idx, type) {
      const input = document.querySelector(`input[name="image-${type}-${idx}"]`);
      const preview = document.getElementById(`preview-${type}-${idx}`);
      const deleteBtn = document.getElementById(`delete-${type}-${idx}`);
      if (input) input.value = "";
      if (preview) { preview.src = ""; preview.style.display = 'none'; }
      if (deleteBtn) deleteBtn.style.display = 'none';
      autoSave();
    }

    // move ID ì¹´ìš´í„°
    let moveCounter = 0;
    function getMoveId() {
      moveCounter++;
      return `move_${String(moveCounter).padStart(2, '0')}`;
    }

    // AI/HUMAN group ì¹´ìš´í„°
    let aiGroupCounter = 0;
    function getGroupId() {
      aiGroupCounter++;
      return `ai_${String(aiGroupCounter).padStart(2, '0')}`;
    }
    let humanGroupCounter = 0;
    function getHumanGroupId() {
      humanGroupCounter++;
      return `human_${String(humanGroupCounter).padStart(2, '0')}`;
    }

    // ì•„ì´ë””ì–´ ë…¸ë“œ ì¶”ê°€ í•¨ìˆ˜ (ê° ì•„ì´ë””ì–´ ë¸”ë¡ ìƒì„±)
    function addIdeaItem(data = {}) {
      const list = document.getElementById('idea-list');
      const idx = list.children.length + 1;
      const container = document.createElement('div');
      container.className = 'idea-item';
      container.innerHTML = `
        <strong>${idx}. ì•„ì´ë””ì–´</strong>
        <button type="button" class="delete-item" title="ì´ ì•„ì´ë””ì–´ ì‚­ì œ">ì‚­ì œ<\/button>
        <div class="confirm-bar"><span>ì‚­ì œí• ê¹Œìš”?<\/span><button type="button" class="confirm-yes">ì˜ˆ<\/button><button type="button" class="confirm-no">ì•„ë‹ˆì˜¤<\/button><\/div>

        <label>ì•„ì´ë””ì–´ ìœ í˜• ì„ íƒ:</label>
        <div class="role-buttons">
          <button type="button" data-role="0">ì‚¬ëŒ</button>
          <button type="button" data-role="1">AI</button>
        </div>
        <input type="hidden" name="role-${idx}" value="${data.role||''}" />

        <!-- ì‚¬ëŒ ì…ë ¥ ë¸”ë¡ -->
        <div class="human-input" style="display:${data.role==='1'?'none':'block'};">
          <label>ì•„ì´ë””ì–´ ë‚´ìš©:</label>
          <textarea name="idea-${idx}" rows="3">${data.idea||''}</textarea>

          <label>ê´€ë ¨ ì´ë¯¸ì§€ (ìŠ¤ì¼€ì¹˜ ë“±):</label>
          <input type="file" name="image-human-${idx}" accept="image/*" onchange="previewImage(event, ${idx}, 'human')">
          <div class="image-controls">
            <img id="preview-human-${idx}" class="preview" src="${data.imagePreview||''}" style="display:${data.imagePreview?'block':'none'};" />
            <button type="button" id="delete-human-${idx}" style="display:${data.imagePreview?'inline-block':'none'};" onclick="deleteImage(${idx}, 'human')">ì‚­ì œ</button>
          </div>
        </div>

        <!-- AI ì…ë ¥ ë¸”ë¡ -->
        <div class="ai-options" style="display:${data.role==='1'?'block':'none'};">
          <label>ì‚¬ìš©í•œ ì´ë¯¸ì§€ ìƒì„± í”Œë«í¼ íƒœê·¸:</label>
          <div class="platform-tag-buttons">
            <button type="button" data-platform="GPT">GPT</button>
            <button type="button" data-platform="Midjourney">Midjourney</button>
            <button type="button" data-platform="Gemini">Gemini</button>
            <button type="button" data-platform="Prome AI">Prome AI</button>
            <button type="button" data-platform="Other">ê¸°íƒ€</button>
          </div>
          <input type="text" name="platform-other-${idx}" placeholder="ê¸°íƒ€ í”Œë«í¼ ì´ë¦„ ì…ë ¥" style="display:none; margin-top: 0.5rem;" value="${data.platformOther||''}" />
          <input type="hidden" name="platform-${idx}" value="${data.platform||''}">

          <label>ì…ë ¥í•œ í”„ë¡¬í”„íŠ¸:</label>
          <textarea name="prompt-${idx}" rows="2">${data.prompt||''}</textarea>

          <label>í•´ë‹¹ í”„ë¡¬í”„íŠ¸ê°€ AI(GPT ë“±)ì˜ ë„ì›€ì„ ë°›ì•˜ë‚˜ìš”?</label>
          <div class="gpt-help-buttons">
            <button type="button" data-gpt="yes">ì˜ˆ</button>
            <button type="button" data-gpt="no">ì•„ë‹ˆì˜¤</button>
          </div>
          <input type="hidden" name="gpt-help-${idx}" value="${data.gptHelp||''}">

          <label>í”„ë¡¬í”„íŠ¸ ë§Œì¡±ë„:</label>
          <div class="satisfaction-buttons">
            <button type="button" data-satisfaction="5">ğŸ˜ ë§¤ìš° ë§Œì¡±</button>
            <button type="button" data-satisfaction="4">ğŸ˜Š ë§Œì¡±</button>
            <button type="button" data-satisfaction="3">ğŸ˜ ë³´í†µ</button>
            <button type="button" data-satisfaction="2">â˜¹ï¸ ë¶ˆë§Œì¡±</button>
            <button type="button" data-satisfaction="1">ğŸ˜  ë§¤ìš° ë¶ˆë§Œì¡±</button>
          </div>
          <input type="hidden" name="satisfaction-${idx}" value="${data.satisfaction||''}">

          <label>ìƒì„±ëœ ì´ë¯¸ì§€ ì„¤ëª…:</label>
          <textarea name="image-description-${idx}" rows="2">${data.imageDesc||''}</textarea>

          <label>ê´€ë ¨ ì´ë¯¸ì§€:</label>
          <input type="file" name="image-ai-${idx}" accept="image/*" onchange="previewImage(event, ${idx}, 'ai')">
          <div class="image-controls">
            <img id="preview-ai-${idx}" class="preview" src="${data.imagePreview||''}" style="display:${data.imagePreview?'block':'none'};" />
            <button type="button" id="delete-ai-${idx}" style="display:${data.imagePreview?'inline-block':'none'};" onclick="deleteImage(${idx}, 'ai')">ì‚­ì œ</button>
          </div>

          <label>AI ì´ë¯¸ì§€ ë§Œì¡±ë„:</label>
          <div class="image-satisfaction-buttons">
            <button type="button" data-image-satisfaction="5">ğŸ˜ ë§¤ìš° ë§Œì¡±</button>
            <button type="button" data-image-satisfaction="4">ğŸ˜Š ë§Œì¡±</button>
            <button type="button" data-image-satisfaction="3">ğŸ˜ ë³´í†µ</button>
            <button type="button" data-image-satisfaction="2">â˜¹ï¸ ë¶ˆë§Œì¡±</button>
            <button type="button" data-image-satisfaction="1">ğŸ˜  ë§¤ìš° ë¶ˆë§Œì¡±</button>
          </div>
          <input type="hidden" name="image-satisfaction-${idx}" value="${data.imageSatisfaction||''}" />
        </div>
      `;
      list.appendChild(container);

      // ì‚­ì œ ë²„íŠ¼ ë°”ì¸ë”© (ê°€ìš´ë° ì•„ì´í…œ ì‚­ì œ í›„ ìë™ ì¬ë²ˆí˜¸)
      const delBtn = container.querySelector('.delete-item');
      const confirmBar = container.querySelector('.confirm-bar');
      const yesBtn = container.querySelector('.confirm-yes');
      const noBtn = container.querySelector('.confirm-no');

      delBtn.addEventListener('click', (e) => {
        e.preventDefault();
        if (confirmBar) {
          confirmBar.style.display = 'inline-flex';
        } else {
          const go = (typeof window !== 'undefined' && typeof window.confirm === 'function') ? window.confirm('ì´ ì•„ì´ë””ì–´ë¥¼ ì‚­ì œí• ê¹Œìš”?') : true;
          if (go) deleteIdea(container);
        }
      });
      yesBtn.addEventListener('click', (e) => { e.preventDefault(); deleteIdea(container); });
      noBtn.addEventListener('click', (e) => { e.preventDefault(); confirmBar.style.display = 'none'; });

      // 1) ì—­í•  ì„ íƒ ë²„íŠ¼ ë°”ì¸ë”©
      const roleBtns = container.querySelectorAll('.role-buttons button');
      const roleInput = container.querySelector(`input[name="role-${idx}"]`);
      const aiSection = container.querySelector('.ai-options');
      const humanSection = container.querySelector('.human-input');
      roleBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          roleBtns.forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          const role = btn.getAttribute('data-role');
          roleInput.value = role;
          aiSection.style.display = role === '1' ? 'block' : 'none';
          humanSection.style.display = role === '0' ? 'block' : 'none';
          autoSave();
        });
      });
      if (data.role) {
        roleBtns.forEach(b => {
          if (b.getAttribute('data-role') === data.role) {
            b.classList.add('selected');
          }
        });
      }

      // 2) í”Œë«í¼ ë²„íŠ¼ ë°”ì¸ë”©
      const platformBtns = container.querySelectorAll('.platform-tag-buttons button');
      const platformInput = container.querySelector(`input[name="platform-${idx}"]`);
      const platformOtherInput = container.querySelector(`input[name="platform-other-${idx}"]`);
      platformBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          platformBtns.forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          const platform = btn.getAttribute('data-platform');
          platformInput.value = platform;
          platformOtherInput.style.display = platform === 'Other' ? 'block' : 'none';
          autoSave();
        });
      });
      if (data.platform) {
        platformBtns.forEach(b => {
          if (b.getAttribute('data-platform') === data.platform) {
            b.classList.add('selected');
          }
        });
        if (data.platform === 'Other') {
          platformOtherInput.style.display = 'block';
        }
      }

      // 3) GPT ë„ì›€ ë²„íŠ¼ ë°”ì¸ë”©
      const gptBtns = container.querySelectorAll('.gpt-help-buttons button');
      const gptInput = container.querySelector(`input[name="gpt-help-${idx}"]`);
      gptBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          gptBtns.forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          gptInput.value = btn.getAttribute('data-gpt');
          autoSave();
        });
      });
      if (data.gptHelp) {
        gptBtns.forEach(b => {
          if (b.getAttribute('data-gpt') === data.gptHelp) {
            b.classList.add('selected');
          }
        });
      }

      // 4) í”„ë¡¬í”„íŠ¸ ë§Œì¡±ë„ ë²„íŠ¼ ë°”ì¸ë”©
      const satisfactionBtns = container.querySelectorAll('.satisfaction-buttons button');
      const satisfactionInput = container.querySelector(`input[name="satisfaction-${idx}"]`);
      satisfactionBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          satisfactionBtns.forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          satisfactionInput.value = btn.getAttribute('data-satisfaction');
          autoSave();
        });
      });
      if (data.satisfaction) {
        satisfactionBtns.forEach(b => {
          if (b.getAttribute('data-satisfaction') === data.satisfaction) {
            b.classList.add('selected');
          }
        });
      }

      // 5) ì´ë¯¸ì§€ ë§Œì¡±ë„ ë²„íŠ¼ ë°”ì¸ë”©
      const imageSatBtns = container.querySelectorAll('.image-satisfaction-buttons button');
      const imageSatInput = container.querySelector(`input[name="image-satisfaction-${idx}"]`);
      imageSatBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          imageSatBtns.forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          imageSatInput.value = btn.getAttribute('data-image-satisfaction');
          autoSave();
        });
      });
      if (data.imageSatisfaction) {
        imageSatBtns.forEach(b => {
          if (b.getAttribute('data-image-satisfaction') === data.imageSatisfaction) {
            b.classList.add('selected');
          }
        });
      }

      // 6) í…ìŠ¤íŠ¸ ì…ë ¥ ì‹œ ìë™ ì €ì¥
      container.querySelectorAll('textarea').forEach(ta => {
        ta.addEventListener('input', autoSave);
      });
      container.querySelectorAll('input[type="text"]').forEach(inp => {
        inp.addEventListener('input', autoSave);
      });
    }

    // ì•„ì´ë””ì–´ ì‚­ì œ + ì¬ë¹Œë“œ (ë²ˆí˜¸ 1..n ìœ ì§€)
    function deleteIdea(containerEl) {
      const items = Array.from(document.querySelectorAll('.idea-item'));
      const idxToRemove = items.indexOf(containerEl);
      if (idxToRemove < 0) return;

      // í˜„ì¬ í¼ ë°ì´í„°ë¥¼ ìˆ˜ì§‘ (ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ í¬í•¨)
      const data = items.map((item, i) => {
        const idx = i + 1;
        const role = item.querySelector(`input[name=\"role-${idx}\"]`)?.value || '';
        const idea = item.querySelector(`textarea[name=\"idea-${idx}\"]`)?.value || '';
        const platform = item.querySelector(`input[name=\"platform-${idx}\"]`)?.value || '';
        const platformOther = item.querySelector(`input[name=\"platform-other-${idx}\"]`)?.value || '';
        const prompt = item.querySelector(`textarea[name=\"prompt-${idx}\"]`)?.value || '';
        const gptHelp = item.querySelector(`input[name=\"gpt-help-${idx}\"]`)?.value || '';
        const satisfaction = item.querySelector(`input[name=\"satisfaction-${idx}\"]`)?.value || '';
        const imageDesc = item.querySelector(`textarea[name=\"image-description-${idx}\"]`)?.value || '';
        const imageSatisfaction = item.querySelector(`input[name=\"image-satisfaction-${idx}\"]`)?.value || '';
        let imagePreview = '';
        if (role === '0') {
          const p = item.querySelector(`#preview-human-${idx}`);
          imagePreview = p ? p.src : '';
        } else {
          const p = item.querySelector(`#preview-ai-${idx}`);
          imagePreview = p ? p.src : '';
        }
        return { role, idea, platform, platformOther, prompt, gptHelp, satisfaction, imageDesc, imageSatisfaction, imagePreview };
      });

      data.splice(idxToRemove, 1); // ì‚­ì œ

      // ë¦¬ìŠ¤íŠ¸ë¥¼ ê¹¨ë—ì´ ì§€ìš°ê³  ë‹¤ì‹œ ìƒì„± (ì¸ë±ìŠ¤ ì¬ë¶€ì—¬)
      const list = document.getElementById('idea-list');
      list.innerHTML = '';
      data.forEach(d => addIdeaItem(d));
      autoSave();
    }

    // ìë™ ì €ì¥ í•¨ìˆ˜ (localStorage)
    function autoSave() {
      const items = document.querySelectorAll('.idea-item');
      const backupData = [];
      items.forEach((item, i) => {
        const idx = i + 1;
        const role = item.querySelector(`input[name=\"role-${idx}\"]`)?.value || '';
        const idea = item.querySelector(`textarea[name=\"idea-${idx}\"]`)?.value || '';
        const platform = item.querySelector(`input[name=\"platform-${idx}\"]`)?.value || '';
        const platformOther = item.querySelector(`input[name=\"platform-other-${idx}\"]`)?.value || '';
        const prompt = item.querySelector(`textarea[name=\"prompt-${idx}\"]`)?.value || '';
        const gptHelp = item.querySelector(`input[name=\"gpt-help-${idx}\"]`)?.value || '';
        const satisfaction = item.querySelector(`input[name=\"satisfaction-${idx}\"]`)?.value || '';
        const imageDesc = item.querySelector(`textarea[name=\"image-description-${idx}\"]`)?.value || '';
        const imageSatisfaction = item.querySelector(`input[name=\"image-satisfaction-${idx}\"]`)?.value || '';

        let imagePreview = '';
        if (role === '0') {
          const previewHuman = item.querySelector(`#preview-human-${idx}`);
          imagePreview = previewHuman ? previewHuman.src : '';
        } else {
          const previewAi = item.querySelector(`#preview-ai-${idx}`);
          imagePreview = previewAi ? previewAi.src : '';
        }

        backupData.push({
          role,
          idea,
          platform,
          platformOther,
          prompt,
          gptHelp,
          satisfaction,
          imageDesc,
          imageSatisfaction,
          imagePreview
        });
      });
      localStorage.setItem('ideaFormBackup', JSON.stringify(backupData));
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë³µì›
    window.onload = function() {
      const saved = localStorage.getItem('ideaFormBackup');
      if (saved) {
        const backupData = JSON.parse(saved);
        backupData.forEach(data => addIdeaItem(data));
      } else {
        for (let i = 0; i < 3; i++) addIdeaItem();
      }
    }

    // ì…ë ¥ ì¶”ê°€ ë²„íŠ¼
    document.getElementById('add-button').onclick = () => addIdeaItem();

    // ì°¸ê°€ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (ê¸°ë³¸ê°’ student01)
    function getStudentName() {
      const nameField = document.getElementById('student-name').value.trim();
      return nameField ? nameField : 'student01';
    }

    // dataURL -> Blob í—¬í¼
    function dataURLToBlob(dataURL) {
      const parts = dataURL.split(',');
      const mime = (parts[0].match(/data:(.*?);/) || [,'image/png'])[1];
      const binary = atob(parts[1]);
      const len = binary.length;
      const u8 = new Uint8Array(len);
      for (let i = 0; i < len; i++) u8[i] = binary.charCodeAt(i);
      return new Blob([u8], { type: mime });
    }
    function getExtFromDataURL(dataURL) {
      try {
        const mime = dataURL.substring(5, dataURL.indexOf(';')); // image/png
        const ext = mime.split('/')[1] || 'png';
        return ext === 'jpeg' ? 'jpg' : ext;
      } catch (e) { return 'png'; }
    }

    // ZIP ì €ì¥ ë²„íŠ¼ (íŒŒì¼ ì—†ì„ ê²½ìš° ë¯¸ë¦¬ë³´ê¸° dataURLë¡œ ë³´ì¡´)
    document.getElementById('save-json').onclick = async () => {
      const items = document.querySelectorAll('.idea-item');
      const episode = [];
      const zip = new JSZip();
      let valid = true;

      moveCounter = 0; // ë¦¬ì…‹
      aiGroupCounter = 0;
      humanGroupCounter = 0;

      for (let i = 0; i < items.length; i++) {
        const idx = i + 1;
        const item = items[i];
        const role = item.querySelector(`input[name=\"role-${idx}\"]`)?.value;
        if (!role) valid = false;

        const moveId = getMoveId();

        if (role === '0') {
          // ì‚¬ëŒì´ ì…ë ¥
          const groupId = getHumanGroupId();
          const text = item.querySelector(`textarea[name=\"idea-${idx}\"]`)?.value.trim();
          if (!text) valid = false;
          episode.push({ id: moveId, actor: 0, text, group_id: groupId, category_no: idx });

          // ì—…ë¡œë“œ ì´ë¯¸ì§€ -> ZIP, ì—†ìœ¼ë©´ ë¯¸ë¦¬ë³´ê¸° dataURL ì‚¬ìš©
          const imageInput = item.querySelector(`input[name=\"image-human-${idx}\"]`);
          if (imageInput && imageInput.files.length > 0) {
            const file = imageInput.files[0];
            const ext = file.name.split('.').pop();
            const filename = `image-human-${idx}.${ext}`;
            const buffer = await file.arrayBuffer();
            zip.file(filename, buffer);
            const moveId3 = getMoveId();
            episode.push({ id: moveId3, actor: 0, type: 'image_file', imageFilename: filename, group_id: groupId, category_no: idx });
          } else {
            const preview = item.querySelector(`#preview-human-${idx}`);
            if (preview && preview.src && preview.src.startsWith('data:')) {
              const ext = getExtFromDataURL(preview.src);
              const filename = `image-human-${idx}.${ext}`;
              const blob = dataURLToBlob(preview.src);
              zip.file(filename, blob);
              const moveId3 = getMoveId();
              episode.push({ id: moveId3, actor: 0, type: 'image_file', imageFilename: filename, group_id: groupId, category_no: idx });
            }
          }

        } else if (role === '1') {
          // AI ì…ë ¥
          const groupId = getGroupId();
          const platform = item.querySelector(`input[name=\"platform-${idx}\"]`)?.value;
          const platformOther = item.querySelector(`input[name=\"platform-other-${idx}\"]`)?.value.trim();
          const entryPlatform = platform === 'Other' ? platformOther : platform;
          const prompt = item.querySelector(`textarea[name=\"prompt-${idx}\"]`)?.value.trim();
          const gptHelp = item.querySelector(`input[name=\"gpt-help-${idx}\"]`)?.value;
          const satisfaction = item.querySelector(`input[name=\"satisfaction-${idx}\"]`)?.value;
          const imageDesc = item.querySelector(`textarea[name=\"image-description-${idx}\"]`)?.value.trim();
          const imageSatisfaction = item.querySelector(`input[name=\"image-satisfaction-${idx}\"]`)?.value;

          if (!entryPlatform || !prompt || !gptHelp || !satisfaction) valid = false;

          episode.push({ id: moveId, actor: 1, type: 'prompt', platform: entryPlatform, gpt_help: gptHelp, satisfaction, text: prompt, group_id: groupId, category_no: idx });

          if (imageDesc) {
            const moveId2 = getMoveId();
            episode.push({ id: moveId2, actor: 1, type: 'image_description', text: imageDesc, group_id: groupId, category_no: idx });
          }

          // ì—…ë¡œë“œ ì´ë¯¸ì§€ -> ZIP, ì—†ìœ¼ë©´ ë¯¸ë¦¬ë³´ê¸° dataURL ì‚¬ìš©
          const imageInput = item.querySelector(`input[name=\"image-ai-${idx}\"]`);
          if (imageInput && imageInput.files.length > 0) {
            const file = imageInput.files[0];
            const ext = file.name.split('.').pop();
            const filename = `image-ai-${idx}.${ext}`;
            const buffer = await file.arrayBuffer();
            zip.file(filename, buffer);
            const moveId3 = getMoveId();
            episode.push({ id: moveId3, actor: 1, type: 'image_file', imageFilename: filename, image_satisfaction: imageSatisfaction, group_id: groupId, category_no: idx });
          } else {
            const preview = item.querySelector(`#preview-ai-${idx}`);
            if (preview && preview.src && preview.src.startsWith('data:')) {
              const ext = getExtFromDataURL(preview.src);
              const filename = `image-ai-${idx}.${ext}`;
              const blob = dataURLToBlob(preview.src);
              zip.file(filename, blob);
              const moveId3 = getMoveId();
              episode.push({ id: moveId3, actor: 1, type: 'image_file', imageFilename: filename, image_satisfaction: imageSatisfaction, group_id: groupId, category_no: idx });
            }
          }
        }
      }

      if (!valid) {
        alert('ëª¨ë“  í•„ìˆ˜ í•­ëª©(ì—­í• , í…ìŠ¤íŠ¸, GPT ë„ì›€ ì—¬ë¶€, ë§Œì¡±ë„ ë“±)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const studentName = getStudentName();
      const jsonData = {}; jsonData[studentName] = episode;
      zip.file(`${studentName}.json`, JSON.stringify(jsonData, null, 2));
      localStorage.removeItem('ideaFormBackup');
      const blob = await zip.generateAsync({ type: 'blob' });
      saveAs(blob, `${studentName}.zip`);
    };
  </script>
</body>
</html>
