<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>디자인 아이디어 기록 시스템</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background-color: #fff;
      max-width: 1000px;
      margin: auto;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }
    .guide {
      font-size: 0.95rem;
      background-color: #f9f9f9;
      border-left: 4px solid #888;
      padding: 1rem;
      margin-bottom: 2rem;
      line-height: 1.6;
    }
    .idea-item {
      margin-bottom: 1.5rem;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .idea-item strong {
      font-size: 1.3rem;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 0.8rem;
    }
    textarea, input[type="text"] {
      width: 100%;
      padding: 0.5rem;
      box-sizing: border-box;
      margin-top: 0.3rem;
    }
    .role-buttons button,
    .platform-tag-buttons button,
    .gpt-help-buttons button,
    .satisfaction-buttons button {
      margin-right: 1rem;
      margin-top: 0.3rem;
      padding: 0.4rem 1rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background-color: #eee;
      color: #333;
    }
    .role-buttons button.selected[data-role="0"] {
      background-color: #e74c3c;
      color: white;
    }
    .role-buttons button.selected[data-role="1"] {
      background-color: #3498db;
      color: white;
    }
    .platform-tag-buttons button.selected,
    .gpt-help-buttons button.selected,
    .satisfaction-buttons button.selected {
      background-color: #2ecc71;
      color: white;
    }
    .add-button {
      display: block;
      margin: 1rem auto;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      border: none;
      background-color: #333;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
    }
    img.preview {
      margin-top: 0.5rem;
      max-width: 200px;
      display: none;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>디자인 아이디어 기록</h1>
  <div class="guide">
    <p><strong>실험 목적:</strong> 이 폼은 여러분이 디자인 과정에서 만든 아이디어를 기록하고, 그 아이디어가 어떻게 생성되고 연관되는지를 분석하기 위한 실험입니다.</p>
    <ul>
      <li>1. 아이디어가 떠오른 순서대로 입력하세요.</li>
      <li>2. 그 아이디어가 <strong>'직접 생각한 것'</strong>인지 <strong>'AI 이미지 생성기를 활용한 것'</strong>인지 선택하세요.</li>
      <li>3. AI 이미지 생성기를 사용했다면 어떤 플랫폼을 사용했는지 선택하고, 프롬프트와 생성된 이미지 설명을 입력하세요.</li>
      <li>4. 프롬프트를 작성할 때 AI의 도움(GPT 등)을 받았는지도 표시해주세요.</li>
      <li>5. 프롬프트 만족도를 선택하세요.</li>
      <li>6. 모든 항목을 성실히 작성해야 저장할 수 있습니다.</li>
    </ul>
  </div>

  <div id="idea-list"></div>
  <button class="add-button" id="add-button">입력 추가</button>
  <button class="add-button" id="save-json">ZIP 저장</button>

  <script>
    function previewImage(event, idx) {
      const input = event.target;
      const preview = document.getElementById(`preview-${idx}`);
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.src = e.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    function addIdeaItem(data = {}) {
      const list = document.getElementById('idea-list');
      const idx = list.children.length + 1;
      const container = document.createElement('div');
      container.className = 'idea-item';
      container.innerHTML = `
        <strong>${idx}. 아이디어</strong>

        <label>아이디어 유형 선택:</label>
        <div class="role-buttons">
          <button type="button" data-role="0">사람</button>
          <button type="button" data-role="1">AI</button>
        </div>
        <input type="hidden" name="role-${idx}" value="${data.role||''}" />

        <div class="human-input" style="display:${data.role==='1'?'none':'block'};">
          <label>아이디어 내용:</label>
          <textarea name="idea-${idx}" rows="3">${data.idea||''}</textarea>
        </div>

        <div class="ai-options" style="display:${data.role==='1'?'block':'none'};">
          <label>사용한 이미지 생성 플랫폼 태그:</label>
          <div class="platform-tag-buttons">
            <button type="button" data-platform="GPT">GPT</button>
            <button type="button" data-platform="Midjourney">Midjourney</button>
            <button type="button" data-platform="Stable Diffusion">Stable Diffusion</button>
            <button type="button" data-platform="Prome AI">Prome AI</button>
            <button type="button" data-platform="Other">기타</button>
          </div>
          <input type="text" name="platform-other-${idx}" placeholder="기타 플랫폼 이름 입력" style="display:none; margin-top: 0.5rem;" value="${data.platformOther||''}" />
          <input type="hidden" name="platform-${idx}" value="${data.platform||''}">

          <label>입력한 프롬프트:</label>
          <textarea name="prompt-${idx}" rows="2">${data.prompt||''}</textarea>

          <label>해당 프롬프트가 AI(GPT 등)의 도움을 받았나요?</label>
          <div class="gpt-help-buttons">
            <button type="button" data-gpt="yes">예</button>
            <button type="button" data-gpt="no">아니오</button>
          </div>
          <input type="hidden" name="gpt-help-${idx}" value="${data.gptHelp||''}">

          <label>프롬프트 만족도:</label>
          <div class="satisfaction-buttons">
            <button type="button" data-satisfaction="5">😍 매우 만족</button>
            <button type="button" data-satisfaction="4">😊 만족</button>
            <button type="button" data-satisfaction="3">😐 보통</button>
            <button type="button" data-satisfaction="2">☹️ 불만족</button>
            <button type="button" data-satisfaction="1">😠 매우 불만족</button>
          </div>
          <input type="hidden" name="satisfaction-${idx}" value="${data.satisfaction||''}">

          <label>생성된 이미지 설명:</label>
          <textarea name="image-description-${idx}" rows="2">${data.imageDesc||''}</textarea>
        </div>

        <label>관련 이미지:</label>
        <input type="file" name="image-${idx}" accept="image/*" onchange="previewImage(event, ${idx})">
        <img id="preview-${idx}" class="preview" />
      `;
      list.appendChild(container);

      const roleBtns = container.querySelectorAll('.role-buttons button');
      const roleInput = container.querySelector(`input[name="role-${idx}"]`);
      const aiSection = container.querySelector('.ai-options');
      const humanSection = container.querySelector('.human-input');
      // Bind role selection
      roleBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          roleBtns.forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          const role = btn.getAttribute('data-role');
          roleInput.value = role;
          aiSection.style.display = role === '1' ? 'block' : 'none';
          humanSection.style.display = role === '0' ? 'block' : 'none';
          autoSave();
        });
      });
      // Preselect if data exists
      if(data.role!==''){
        roleBtns.forEach(b=>{ if(b.getAttribute('data-role')===data.role) b.classList.add('selected'); });
      }

      const platformBtns = container.querySelectorAll('.platform-tag-buttons button');
      const platformInput = container.querySelector(`input[name="platform-${idx}"]`);
      const platformOtherInput = container.querySelector(`input[name="platform-other-${idx}"]`);
      platformBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          platformBtns.forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          const platform = btn.getAttribute('data-platform');
          platformInput.value = platform;
          platformOtherInput.style.display = platform === 'Other' ? 'block' : 'none';
          autoSave();
        });
      });
      if(data.platform){ platformBtns.forEach(b=>{ if(b.getAttribute('data-platform')===data.platform) b.classList.add('selected'); }); if(data.platform==='Other') platformOtherInput.style.display='block'; }

      const gptBtns = container.querySelectorAll('.gpt-help-buttons button');
      const gptInput = container.querySelector(`input[name="gpt-help-${idx}"]`);
      gptBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          gptBtns.forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          gptInput.value = btn.getAttribute('data-gpt');
          autoSave();
        });
      });
      if(data.gptHelp){ gptBtns.forEach(b=>{ if(b.getAttribute('data-gpt')===data.gptHelp) b.classList.add('selected'); }); }

      const satisfactionBtns = container.querySelectorAll('.satisfaction-buttons button');
      const satisfactionInput = container.querySelector(`input[name="satisfaction-${idx}"]`);
      satisfactionBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          satisfactionBtns.forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          satisfactionInput.value = btn.getAttribute('data-satisfaction');
          autoSave();
        });
      });
      if(data.satisfaction){ satisfactionBtns.forEach(b=>{ if(b.getAttribute('data-satisfaction')===data.satisfaction) b.classList.add('selected'); }); }

      // Preview existing image if URL stored (not base64 saved)
      if(data.imagePreview){
        const preview = container.querySelector(`#preview-${idx}`);
        preview.src = data.imagePreview;
        preview.style.display = 'block';
      }
    }

    function autoSave() {
      // Save inner HTML and capture image previews
      const items = document.querySelectorAll('.idea-item');
      const backupData = [];
      items.forEach((item, i) => {
        const idx = i+1;
        const role = item.querySelector(`input[name="role-${idx}"]`).value;
        const idea = item.querySelector(`textarea[name="idea-${idx}"]`).value;
        const platform = item.querySelector(`input[name="platform-${idx}"]`).value;
        const platformOther = item.querySelector(`input[name="platform-other-${idx}"]`).value;
        const prompt = item.querySelector(`textarea[name="prompt-${idx}"]`).value;
        const gptHelp = item.querySelector(`input[name="gpt-help-${idx}"]`).value;
        const satisfaction = item.querySelector(`input[name="satisfaction-${idx}"]`).value;
        const imageDesc = item.querySelector(`textarea[name="image-description-${idx}"]`).value;
        const preview = item.querySelector(`#preview-${idx}`);
        const imagePreview = preview.src || '';
        backupData.push({ role, idea, platform, platformOther, prompt, gptHelp, satisfaction, imageDesc, imagePreview });
      });
      localStorage.setItem('ideaFormBackup', JSON.stringify(backupData));
    }

    window.onload = function() {
      const saved = localStorage.getItem('ideaFormBackup');
      if(saved) {
        const backupData = JSON.parse(saved);
        backupData.forEach(data => addIdeaItem(data));
      } else {
        for(let i=0; i<3; i++) addIdeaItem();
      }
    }

    document.getElementById('add-button').onclick = () => addIdeaItem();

    document.getElementById('save-json').onclick = async () => {
      const items = document.querySelectorAll('.idea-item');
      const episode = [];
      const zip = new JSZip();
      let valid = true;

      for(let i=0; i<items.length; i++) {
        const idx = i+1;
        const item = items[i];
        const role = item.querySelector(`input[name="role-${idx}"]`).value;
        if(!role) valid = false;
        if(role === '0') {
          const text = item.querySelector(`textarea[name="idea-${idx}"]`).value.trim();
          if(!text) valid = false;
          episode.push({ actor: 0, text });
        } else if(role === '1') {
          const platform = item.querySelector(`input[name="platform-${idx}"]`).value;
          const platformOther = item.querySelector(`input[name="platform-other-${idx}"]`).value
          || '';
          const prompt = item.querySelector(`textarea[name="prompt-${idx}"]`).value.trim();
          const gptHelp = item.querySelector(`input[name="gpt-help-${idx}"]`).value;
          const satisfaction = item.querySelector(`input[name="satisfaction-${idx}"]`).value;
          const imageDesc = item.querySelector(`textarea[name="image-description-${idx}"]`).value.trim();
          if(!platform || !prompt || !gptHelp || !satisfaction) valid = false;
          const entryPlatform = platform === 'Other' ? platformOther : platform;
          episode.push({ actor:1, type:'prompt', platform: entryPlatform, gpt_help:gptHelp, satisfaction, text:prompt });
          if(imageDesc) episode.push({ actor:1, type:'image_description', text:imageDesc });
        }
        const imageInput = item.querySelector(`input[name="image-${idx}"]`);
        if(imageInput && imageInput.files.length>0) {
          const file = imageInput.files[0];
          const ext = file.name.split('.').pop();
          const filename = `image-${idx}.${ext}`;
          const buffer = await file.arrayBuffer();
          zip.file(filename, buffer);
          episode.push({ actor: parseInt(role||0), type:'image_file', imageFilename:filename });
        }
      }
      if(!valid) return alert('모든 필수 항목을 입력하세요.');
      zip.file('student01.json', JSON.stringify({ student01: episode }, null, 2));
      localStorage.removeItem('ideaFormBackup');
      const blob = await zip.generateAsync({ type:'blob' });
      saveAs(blob, 'student01.zip');
    };
  </script>
</body>
</html>
